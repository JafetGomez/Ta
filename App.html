<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sistema de Pago de Facturas - Admin</title>
	
	<style>
		/* 1. Reset y Fuente */
		:root {
			font-family: 'Inter', sans-serif;
			--color-primary: #4f46e5; /* Indigo-600 */
			--color-primary-dark: #4338ca; /* Indigo-700 */
			--color-background: #f3f4f6; /* Gray-100 */
			--color-card-bg: #ffffff;
			--color-text-dark: #1f2937; /* Gray-800 */
			--color-text-medium: #6b7280; /* Gray-500 */
            --color-success: #059669; /* Green-600 */
            --color-warning: #d97706; /* Amber-600 */
		}
		*, *::before, *::after {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		/* 2. Estilo del Body (Fondo y Centrado) */
		body {
			background-color: var(--color-background);
			display: flex;
			align-items: flex-start; /* Alineación superior para evitar desbordamiento */
			justify-content: center;
			min-height: 100vh;
			padding: 2rem 1rem;
		}

		/* 3. Contenedor principal de la aplicación */
		.app-container {
			width: 100%;
			max-width: 900px;
			margin-top: 2rem;
		}

		/* 4. Contenedor de Formulario (Tarjeta) - Aplicado a Login y Main App */
		.card {
			background-color: var(--color-card-bg);
			padding: 2rem;
			border-radius: 0.75rem;
			box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
			transition: all 300ms ease-in-out;
			margin-bottom: 2rem;
		}

		/* 5. Cabecera */
		.header {
			text-align: center;
			margin-bottom: 2rem;
		}

		.header h1 {
			font-size: 1.875rem;
			font-weight: 800;
			color: var(--color-text-dark);
			margin-bottom: 0.5rem;
		}

		.header p {
			color: var(--color-text-medium);
			font-size: 0.875rem;
		}
		
		/* 6. Formulario y Grupos */
		.form-group {
			margin-bottom: 1.5rem;
		}

		.form-group label {
			display: block;
			font-size: 0.875rem;
			font-weight: 500;
			color: var(--color-text-dark);
			margin-bottom: 0.25rem;
		}

		.form-group input, .form-group select {
			width: 100%;
			padding: 0.6rem 1rem;
			border: 1px solid #d1d5db;
			border-radius: 0.5rem;
			box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
			transition: all 150ms ease-in-out;
		}
		
		.form-group input:focus, .form-group select:focus {
			outline: 2px solid transparent;
			outline-offset: 2px;
			border-color: var(--color-primary);
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
		}

		/* 7. Botones */
		.btn {
			display: block;
			width: 100%;
			background-color: var(--color-primary);
			color: white;
			padding: 0.75rem 1.5rem;
			border-radius: 0.5rem;
			font-weight: 500;
			border: none;
			cursor: pointer;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
			transition: background-color 150ms ease-in-out, box-shadow 150ms ease-in-out;
			text-align: center;
		}

		.btn:hover {
			background-color: var(--color-primary-dark);
			box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
		}
		
		.btn:disabled {
			background-color: #9ca3af; 
			cursor: not-allowed;
			box-shadow: none;
		}
		.button-row {
			display: flex;
			gap: 1rem; /* Espacio entre los botones */
			margin-top: 1rem;
		}

		/* Asegurar que los botones dentro del grupo compartan el espacio y se anule el width: 100% */
		.button-row .btn {
			width: auto;
			flex: 1; /* Distribuye el espacio equitativamente */
			margin-top: 0;
			}

		/* Estilo secundario para diferenciar el botón de consulta */
		.btn-secondary {
			background-color: #6b7280; 
			}

		.btn-secondary:hover {
			background-color: #4b5563; 
			}
		

		/* 8. Estilos de Mensajes (Alertas) */
		.message-box {
			text-align: center;
			font-size: 0.875rem;
			padding: 0.75rem;
			border-radius: 0.5rem;
			margin-top: 1rem;
			display: none;
		}

		.hidden { display: none !important; }
		.success { background-color: #d1fae5; color: #065f46; border: 1px solid #34d399; } /* Green */
		.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #f87171; } /* Red */
		.info { background-color: #e0f2fe; color: #075985; border: 1px solid #38bdf8; } /* Blue */
		.warning { background-color: #fef3c7; color: #92400e; border: 1px solid #fbbf24; } /* Yellow */

		/* 9. Layout de la Aplicación Principal */
		.main-grid {
			display: grid;
			grid-template-columns: 1fr;
			gap: 2rem;
		}

		@media (min-width: 768px) {
			.main-grid {
				grid-template-columns: 2fr 1fr; /* Panel principal y panel de pago */
			}
		}

		/* 10. Bloques de Información */
		.info-block {
			margin-top: 1.5rem;
			padding: 1.5rem;
			border: 1px solid #e5e7eb;
			border-radius: 0.5rem;
		}

		.info-block h3 {
			font-size: 1.125rem;
			font-weight: 600;
			margin-bottom: 1rem;
			color: var(--color-primary-dark);
			border-bottom: 2px solid var(--color-primary);
			padding-bottom: 0.5rem;
		}

		.data-row {
			display: flex;
			justify-content: space-between;
			padding: 0.3rem 0;
			border-bottom: 1px dotted #e5e7eb;
			font-size: 0.9rem;
		}

		.data-row:last-child {
			border-bottom: none;
			font-weight: 600;
			color: var(--color-text-dark);
			padding-top: 0.5rem;
		}

		.data-label {
			color: var(--color-text-medium);
			font-weight: 500;
		}

		.data-value {
			text-align: right;
		}
        
        /* 11. Estilos para la tabla de facturas */
        #invoiceListContainer table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        #invoiceListContainer thead th {
            text-align: left;
            padding: 0.75rem 0.5rem;
            background-color: #e5e7eb;
            font-weight: 600;
            color: var(--color-text-dark);
            position: sticky; /* Sticky header */
            top: 0;
        }

        #invoiceListContainer tbody td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #f3f4f6;
        }

        #invoiceListContainer tbody tr:hover {
            background-color: #f9fafb;
        }

        .status-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .status-pendiente {
            background-color: #fef3c7; 
            color: var(--color-warning);
            border: 1px solid #fde68a;
        }

        .status-pagada {
            background-color: #d1fae5; 
            color: var(--color-success);
            border: 1px solid #a7f3d0;
        }

        .status-row-pendiente {
            background-color: #fffbeb; 
        }
	</style>
</head>
<body>
	<div class="app-container">
		
		<!-- ---------------------------------------------------- -->
		<!-- LOGIN -->
		<!-- ---------------------------------------------------- -->
		<div id="loginView" class="card">
			<header class="header">
				<h1>Acceso al Sistema</h1>
				<p>Introduce tus credenciales de administrador.</p>
			</header>
			
			<form id="loginForm">
				<div class="form-group">
					<label for="usuario">Usuario</label>
					<input 
						type="text" 
						id="usuario" 
						required 
						placeholder="Ej: JuanGra"
					>
				</div>

				<div class="form-group">
					<label for="contrasena">Contraseña</label>
					<input 
						type="password" 
						id="contrasena" 
						required 
						placeholder="Ej: Juan1987*"
					>
				</div>

				<button 
					type="submit" 
					class="btn"
					id="loginButton"
				>
					Iniciar Sesión
				</button>

				<div id="loginMessageBox" class="message-box hidden" role="alert"></div>
			</form>
		</div>
		
		<!-- ---------------------------------------------------- -->
		<!-- MAIN APPLICATION (OCULTO INICIALMENTE) -->
		<!-- ---------------------------------------------------- -->
		<div id="mainAppView" class="hidden">
			
			<div class="card">
				<header class="header" style="margin-bottom: 0;">
					<h1 style="font-size: 1.5rem;">Gestión de Pagos <span id="welcomeUser" style="color: var(--color-primary);"></span></h1>
					<p>Busca una propiedad por número de finca o ID de Persona.</p>
				</header>
			</div>

			<div class="main-grid">
				
				<!-- PANEL IZQUIERDO: BÚSQUEDA Y DETALLE DE FACTURA -->
				<div>
					<!-- BÚSQUEDA DE PROPIEDAD -->
					<div class="card">
						<h3>Buscar Propiedad y Facturas</h3>
						<form id="searchForm">
							<div class="form-group" style="margin-bottom: 1rem;">
								<label for="searchTerm">Término de Búsqueda</label>
								<input 
									type="text" 
									id="searchTerm" 
									required 
									placeholder="Finca o ID de persona"
								>
							</div>
							<div class="button-row">
								<button 
									type="submit" 
									class="btn"
									id="searchButton"
								>
									Factura Pendiente (Pagar)
								</button>
								<button 
									type="button" 
									class="btn btn-secondary"
									id="consulButton"
								>
									Consultar Historial
								</button>
							</div>
							<div id="searchMessageBox" class="message-box hidden" role="alert"></div>
						</form>

						<!-- DETALLES DE LA PROPIEDAD -->
						<div id="propertyDetails" class="info-block hidden">
							<h3>Detalles de la Propiedad</h3>
							<div class="data-row"><span class="data-label">Finca:</span> <span id="propFinca" class="data-value"></span></div>
							<div class="data-row"><span class="data-label">Uso:</span> <span id="propUso" class="data-value"></span></div>
							<div class="data-row"><span class="data-label">M²:</span> <span id="propMetros" class="data-value"></span></div>
							<div class="data-row"><span class="data-label">Valor Fiscal:</span> <span id="propValorFiscal" class="data-value"></span></div>
							<div class="data-row"><span class="data-label">Saldo M³:</span> <span id="propSaldoM3" class="data-value"></span></div>
						</div>

						<!-- DETALLES DE LA FACTURA PENDIENTE MÁS ANTIGUA -->
						<div id="invoiceDetails" class="info-block hidden warning">
							<h3>Factura Pendiente más Antigua</h3>
							<div class="data-row"><span class="data-label">Comprobante Nº:</span> <span id="invComprobante" class="data-value"></span></div>
							<div class="data-row"><span class="data-label">Generación:</span> <span id="invGeneracion" class="data-value"></span></div>
							<div class="data-row"><span class="data-label">Vencimiento:</span> <span id="invVencimiento" class="data-value"></span></div>
							<div class="data-row"><span class="data-label">Detalle:</span> <span id="invDetalle" class="data-value" style="font-size: 0.75rem; max-width: 60%;"></span></div>
							<div class="data-row"><span class="data-label">Total a Pagar:</span> <span id="invTotalPagar" class="data-value" style="color: #b91c1c; font-size: 1.25rem;"></span></div>
						</div>
					</div>

                    <!-- RESULTS: LISTA DE FACTURAS COMPLETAS  -->
                    <div id="invoiceListResults" class="card hidden" style="margin-top: 0rem;">
                        <h3>Historial Completo de Facturas</h3>
                        <div id="invoiceListContainer" style="max-height: 400px; overflow-y: auto;">
                            <!-- Aquí se cargará la tabla de facturas -->
                            <p class="info" style="margin-top: 0;">Ingrese un término de búsqueda y haga clic en "Consultar Historial".</p>
                        </div>
                    </div>
				</div>

				<!-- PANEL DERECHO: FORMULARIO DE PAGO -->
				<div>
					<div class="card">
						<h3>Procesar Pago</h3>
						<form id="paymentForm">
							<div class="form-group">
								<label for="pagoMonto">Monto a Pagar (Factura)</label>
								<input 
									type="number" 
									id="pagoMonto" 
									required 
									readonly
									placeholder="Se carga automáticamente"
								>
								<small style="display: block; color: var(--color-text-medium); margin-top: 0.2rem;">Este monto corresponde a la factura pendiente más antigua.</small>
							</div>

							<div class="form-group">
								<label for="pagoReferencia">Número de Referencia (Depósito/Transf.)</label>
								<input 
									type="text" 
									id="pagoReferencia" 
									required 
									placeholder="Ingresa el número de referencia"
								>
							</div>

							<div class="form-group">
								<label for="pagoMedio">Medio de Pago</label>
								<select id="pagoMedio" required>
									<!-- Los IDs (Value) corresponden a la tabla TipoMedioPago -->
									<option value="" disabled selected>Selecciona un medio</option>
									<option value="1">Efectivo</option>
									<option value="2">Transferencia Bancaria</option>
									<option value="3">Tarjeta de Crédito/Débito</option>
								</select>
							</div>

							<button 
								type="submit" 
								class="btn"
								id="payButton"
								disabled
							>
								Confirmar Pago
							</button>
							<div id="paymentMessageBox" class="message-box hidden" role="alert"></div>
						</form>
					</div>

					<!-- COMPROBANTE DE PAGO -->
					<div id="receiptDetails" class="card hidden success">
						<h3>Comprobante de Pago Exitoso</h3>
						<p style="margin-bottom: 0.5rem; font-size: 0.9rem;">El pago se procesó correctamente.</p>
						<div class="data-row"><span class="data-label">Código Transacción:</span> <span id="receiptCodigo" class="data-value"></span></div>
						<div class="data-row"><span class="data-label">Monto Final Pagado:</span> <span id="receiptMonto" class="data-value" style="font-size: 1.25rem;"></span></div>
						<button 
							type="button" 
							class="btn"
							style="margin-top: 1rem; background-color: #047857;"
							onclick="resetApp()"
						>
							Procesar Nueva Transacción
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		// ----------------------------------------------------
		// CONSTANTES Y ESTADO GLOBAL
		// ----------------------------------------------------
		const API_BASE = 'http://localhost:3000'; // Se define el puerto completo para solicitudes CORS
		let user = null;
		let currentProperty = null;
		let currentInvoice = null;

		// ----------------------------------------------------
		// REFERENCIAS DEL DOM
		// ----------------------------------------------------
		const loginView = document.getElementById('loginView');
		const mainAppView = document.getElementById('mainAppView');
		
		// Login
		const loginForm = document.getElementById('loginForm');
		const loginButton = document.getElementById('loginButton');
		const loginMessageBox = document.getElementById('loginMessageBox');
		const welcomeUser = document.getElementById('welcomeUser');

		// Search
		const searchForm = document.getElementById('searchForm');
		const searchButton = document.getElementById('searchButton');
        const consulButton = document.getElementById('consulButton'); 
		const searchMessageBox = document.getElementById('searchMessageBox');
		const propertyDetails = document.getElementById('propertyDetails');
		const invoiceDetails = document.getElementById('invoiceDetails');
        const invoiceListResults = document.getElementById('invoiceListResults'); 
        const invoiceListContainer = document.getElementById('invoiceListContainer'); 

		// Payment
		const paymentForm = document.getElementById('paymentForm');
		const payButton = document.getElementById('payButton');
		const paymentMessageBox = document.getElementById('paymentMessageBox');
		const pagoMontoInput = document.getElementById('pagoMonto');
		const receiptDetails = document.getElementById('receiptDetails');


		// ----------------------------------------------------
		// FUNCIONES DE UTILIDAD (UI & FETCH)
		// ----------------------------------------------------

		/**
		 * Muestra un mensaje en la caja de mensajes especificada.
		 */
		function showMessage(box, text, type = 'error') {
			box.textContent = text;
			box.className = `message-box ${type}`;
			box.style.display = 'block';
		}
		
		/**
		 * Oculta la caja de mensajes.
		 */
		function hideMessage(box) {
			box.style.display = 'none';
		}

		/**
		 * Formatea un número como moneda (ej: ₡1.234,56).
		 */
		function formatCurrency(amount) {
			return new Intl.NumberFormat('es-CR', { 
				style: 'currency', 
				currency: 'CRC',
				minimumFractionDigits: 2,
				maximumFractionDigits: 2
			}).format(amount);
		}
		
		/**
		 * Formatea una fecha como cadena legible (DD/MM/AAAA).
		 */
		function formatDate(dateString) {
			if (!dateString) return 'N/A';
			const date = new Date(dateString);
			return date.toLocaleDateString('es-CR', { 
				year: 'numeric', 
				month: '2-digit', 
				day: '2-digit' 
			});
		}

		/**
		 * Fetch con reintentos y retroceso exponencial.
		 */
		async function fetchWithRetry(url, options = {}, retries = 3) {
			for (let i = 0; i < retries; i++) {
				try {
					const response = await fetch(API_BASE + url, options);
					
					// Si la respuesta es 4xx o 5xx, la manejamos en el catch
					if (response.status >= 400 && response.status < 600) {
						let errorMessage;
						try {
							const errorBody = await response.json();
							errorMessage = errorBody.message || `Error del servidor: ${response.status}`;
						} catch (e) {
							errorMessage = `Error del servidor: ${response.status}. Respuesta no JSON.`;
						}
						throw new Error(errorMessage);
					}

					return response.json();

				} catch (error) {
					// No mostrar reintentos fallidos en la consola para evitar ruido
					// console.error(`Intento ${i + 1} fallido para ${url}:`, error.message);
					if (i < retries - 1) {
						const delay = Math.pow(2, i) * 1000; // Retroceso exponencial: 1s, 2s, 4s
						await new Promise(resolve => setTimeout(resolve, delay));
					} else {
						throw new Error("Conexión fallida o error de servidor después de varios reintentos. " + error.message);
					}
				}
			}
		}


		// ----------------------------------------------------
		// MANEJO DE VISTAS
		// ----------------------------------------------------

		/**
		 * Cambia entre la vista de Login y la aplicación principal.
		 */
		function showMainApp(userName) {
			loginView.classList.add('hidden');
			mainAppView.classList.remove('hidden');
			welcomeUser.textContent = `(${userName})`;
		}

		/**
		 * Restablece el estado de la aplicación para una nueva transacción.
		 */
		function resetApp() {
			currentProperty = null;
			currentInvoice = null;
			
			// Ocultar paneles de detalles
			propertyDetails.classList.add('hidden');
			invoiceDetails.classList.add('hidden');
			receiptDetails.classList.add('hidden');
            invoiceListResults.classList.add('hidden'); // Ocultar la lista de resultados

            // Limpiar lista de facturas
            invoiceListContainer.innerHTML = '<p class="info" style="margin-top: 0;">Ingrese un término de búsqueda y haga clic en "Consultar Historial".</p>';
			
			// Resetear formularios y mensajes
			searchForm.reset();
			paymentForm.reset();
			pagoMontoInput.value = '';
			
			hideMessage(searchMessageBox);
			hideMessage(paymentMessageBox);
			
			payButton.disabled = true;
			searchButton.disabled = false;
            consulButton.disabled = false;
			
			// Habilitar campos de búsqueda y formulario de pago (si estaba oculto)
			document.getElementById('searchTerm').readOnly = false;
			paymentForm.classList.remove('hidden');
		}


		// ----------------------------------------------------
		// MANEJADORES DE EVENTOS
		// ----------------------------------------------------

		/**
		 * 1. MANEJO DEL LOGIN
		 */
		loginForm.addEventListener('submit', async function (event) {
			event.preventDefault();
			
			const username = document.getElementById('usuario').value;
			const password = document.getElementById('contrasena').value;
			
			loginButton.disabled = true;
			showMessage(loginMessageBox, "Iniciando sesión...", 'info');

			try {
				const data = await fetchWithRetry('/api/login', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ username, password })
				});

				if (data.success) {
					user = data.user;
					showMessage(loginMessageBox, `Bienvenido, ${user.nombre}.`, 'success');
					setTimeout(() => showMainApp(user.nombre), 1000);
				} else {
					showMessage(loginMessageBox, data.message || 'Error de autenticación.', 'error');
				}

			} catch (error) {
				showMessage(loginMessageBox, error.message || 'Error de conexión con el servidor de autenticación.', 'error');
				console.error("Login Error:", error);
			} finally {
				loginButton.disabled = false;
			}
		});

		/**
		 * 2. MANEJO DE LA BÚSQUEDA DE PROPIEDAD Y FACTURA PENDIENTE (Botón Pagar)
		 */
		searchForm.addEventListener('submit', async function (event) {
			event.preventDefault();
			
			// Limpiar estado y vistas
			currentProperty = null;
			currentInvoice = null;
			propertyDetails.classList.add('hidden');
			invoiceDetails.classList.add('hidden');
			payButton.disabled = true;
			receiptDetails.classList.add('hidden');
            invoiceListResults.classList.add('hidden'); // Ocultar la vista de lista

			const searchTerm = document.getElementById('searchTerm').value.trim();
			
			searchButton.disabled = true;
            consulButton.disabled = true;
			showMessage(searchMessageBox, "Buscando propiedad...", 'info');

			try {
				// Llamada al ENDPOINT 2: /api/propiedad/search
				const data = await fetchWithRetry(`/api/propiedad/search?term=${encodeURIComponent(searchTerm)}`);

				if (data.success) {
					currentProperty = data.property;
					showMessage(searchMessageBox, `Propiedad ${currentProperty.NumeroFinca} encontrada.`, 'success');
					displayProperty(currentProperty);
					
					// Una vez que tenemos la propiedad, buscamos la factura pendiente
					await fetchOldestPendingInvoice(currentProperty.NumeroFinca);
				} else {
					showMessage(searchMessageBox, data.message || 'Propiedad no encontrada.', 'error');
				}

			} catch (error) {
				showMessage(searchMessageBox, error.message || 'Error al buscar propiedad.', 'error');
				console.error("Search Error:", error);
			} finally {
				searchButton.disabled = false;
                consulButton.disabled = false;
			}
		});
        
        /**
         * 2b. MANEJO DE LA CONSULTA DE TODAS LAS FACTURAS (Botón Consultar Historial)
         */
        consulButton.addEventListener('click', async function () {
            
            // Limpiar estado y vistas
			currentProperty = null;
			currentInvoice = null;
			propertyDetails.classList.add('hidden');
			invoiceDetails.classList.add('hidden');
			payButton.disabled = true;
			receiptDetails.classList.add('hidden');
            paymentForm.classList.add('hidden'); // Ocultar formulario de pago
            invoiceListResults.classList.remove('hidden'); // Mostrar la vista de lista
            
            const searchTerm = document.getElementById('searchTerm').value.trim();
            if (!searchTerm) {
                showMessage(searchMessageBox, "Debe ingresar un número de Finca o ID de persona para consultar el historial.", 'error');
                invoiceListContainer.innerHTML = '<p class="info" style="margin-top: 0;">Ingrese un término de búsqueda y haga clic en "Consultar Historial".</p>';
                return;
            }
            
            searchButton.disabled = true;
            consulButton.disabled = true;
			showMessage(searchMessageBox, "Consultando historial de facturas...", 'info');
            invoiceListContainer.innerHTML = '<p class="info" style="text-align: center;">Cargando...</p>';

            try {
                // Se asume el nuevo endpoint que llama al SP
                // Llamada al ENDPOINT 5: /api/factura/search-all?term=...
                const data = await fetchWithRetry(`/api/factura/search-all?term=${encodeURIComponent(searchTerm)}`);

                if (data.success && data.invoices && data.invoices.length > 0) {
                    showMessage(searchMessageBox, `Se encontraron ${data.invoices.length} facturas (Pendientes y Pagadas).`, 'success');
                    renderInvoiceList(data.invoices);
                    
                    // También buscamos y mostramos los detalles de la propiedad asociada al primer resultado
                    if (data.invoices[0].NumeroFinca) {
                        await fetchPropertyDetails(data.invoices[0].NumeroFinca);
                    }

                } else {
                    showMessage(searchMessageBox, data.message || 'No se encontraron facturas para el término de búsqueda.', 'error');
                    invoiceListContainer.innerHTML = '<p class="error" style="margin-top: 0; padding: 0.5rem; border: none; background: transparent;">No se encontraron facturas (Pendientes o Pagadas).</p>';
                }

            } catch (error) {
                showMessage(searchMessageBox, error.message || 'Error al consultar el historial de facturas.', 'error');
				console.error("All Invoices Search Error:", error);
                invoiceListContainer.innerHTML = '<p class="error" style="margin-top: 0; padding: 0.5rem; border: none; background: transparent;">Error de conexión al obtener el historial.</p>';
            } finally {
                searchButton.disabled = false;
                consulButton.disabled = false;
            }
        });

		/**
		 * FUNCIÓN AUXILIAR: Muestra los detalles de la propiedad
		 */
		function displayProperty(prop) {
			document.getElementById('propFinca').textContent = prop.NumeroFinca || 'N/A';
			document.getElementById('propUso').textContent = prop.UsoPropiedad || 'N/A';
			document.getElementById('propMetros').textContent = prop.MetrosCuadrados ? `${prop.MetrosCuadrados.toLocaleString('es-CR')} m²` : 'N/A';
			document.getElementById('propValorFiscal').textContent = prop.ValorFiscal ? formatCurrency(prop.ValorFiscal) : 'N/A';
			document.getElementById('propSaldoM3').textContent = prop.SaldoM3 || 'N/A'; // Asumiendo que SaldoM3 es un número o string
			propertyDetails.classList.remove('hidden');
		}

        /**
		 * FUNCIÓN AUXILIAR: Busca los detalles de la propiedad
		 */
		async function fetchPropertyDetails(numeroFinca) {
			try {
				const data = await fetchWithRetry(`/api/propiedad/details/${encodeURIComponent(numeroFinca)}`);
				if (data.success && data.property) {
                    currentProperty = data.property;
					displayProperty(currentProperty);
				}
			} catch (error) {
				console.error("Error fetching property details:", error);
			}
		}

        /**
         * FUNCIÓN AUXILIAR: Renderiza la lista de facturas en una tabla
         */
        function renderInvoiceList(invoices) {
            const container = document.getElementById('invoiceListContainer');
            if (invoices.length === 0) {
                container.innerHTML = '<p class="info" style="margin-top: 0;">No se encontraron facturas.</p>';
                return;
            }

            // Construir la tabla
            let html = '<table>';
            html += '<thead><tr><th>Finca</th><th>Comprobante</th><th>Generación</th><th>Total</th><th>Estado</th></tr></thead>';
            html += '<tbody>';

            invoices.forEach(inv => {
                const statusClass = inv.Estado && inv.Estado.toLowerCase().includes('pendiente') ? 'status-pendiente' : 'status-pagada';
                const rowClass = inv.Estado && inv.Estado.toLowerCase().includes('pendiente') ? 'status-row-pendiente' : '';
                html += `<tr class="${rowClass}">`;
                html += `<td>${inv.NumeroFinca || 'N/A'}</td>`;
                html += `<td>${inv.NumeroComprobante || 'N/A'}</td>`;
                html += `<td>${formatDate(inv.FechaGeneracion)}</td>`;
                html += `<td>${formatCurrency(inv.TotalAPagarFinal || 0)}</td>`;
                html += `<td><span class="status-badge ${statusClass}">${inv.Estado || 'N/A'}</span></td>`;
                html += `</tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

		/**
		 * FUNCIÓN AUXILIAR: 3. BUSCAR FACTURA PENDIENTE (Flujo de Pago)
		 */
		async function fetchOldestPendingInvoice(numeroFinca) {
			showMessage(searchMessageBox, "Buscando factura pendiente...", 'info');
			
            // Ocultar la vista de lista de facturas
            invoiceListResults.classList.add('hidden'); 

			try {
				// Llamada al ENDPOINT 3: /api/factura/oldest-pending/:numeroFinca
				const data = await fetchWithRetry(`/api/factura/oldest-pending/${encodeURIComponent(numeroFinca)}`);

				if (data.success) {
					currentInvoice = data.invoice;
					showMessage(searchMessageBox, `Factura pendiente encontrada (Comprobante #${currentInvoice.NumeroComprobante}).`, 'warning');
					displayInvoice(currentInvoice);
					payButton.disabled = false;
					document.getElementById('searchTerm').readOnly = true; // Bloquea búsqueda mientras haya factura
					paymentForm.classList.remove('hidden'); // Asegura que el formulario de pago sea visible
				} else {
					// No hay facturas pendientes
					currentInvoice = null;
					showMessage(searchMessageBox, data.message || 'No hay facturas pendientes para esta propiedad.', 'success');
					invoiceDetails.classList.add('hidden');
					payButton.disabled = true;
					paymentForm.classList.add('hidden'); // Oculta el formulario si no hay nada que pagar
				}

			} catch (error) {
				showMessage(searchMessageBox, error.message || 'Error al buscar la factura pendiente.', 'error');
				console.error("Invoice Search Error:", error);
				payButton.disabled = true;
				paymentForm.classList.add('hidden'); // Oculta el formulario si hay un error
			}
		}

		/**
		 * FUNCIÓN AUXILIAR: Muestra los detalles de la factura
		 */
		function displayInvoice(invoice) {
			document.getElementById('invComprobante').textContent = invoice.NumeroComprobante;
			document.getElementById('invGeneracion').textContent = formatDate(invoice.FechaGeneracion);
			document.getElementById('invVencimiento').textContent = formatDate(invoice.FechaVencimiento);
			document.getElementById('invTotalPagar').textContent = formatCurrency(invoice.TotalAPagarFinal);
			document.getElementById('invDetalle').textContent = invoice.Detalle || 'Sin detalles adicionales.';
			
			// Pre-carga el monto de la factura en el formulario de pago
			pagoMontoInput.value = invoice.TotalAPagarFinal.toFixed(2); 

			invoiceDetails.classList.remove('hidden');
		}

		/**
		 * 4. MANEJO DEL PAGO
		 */
		paymentForm.addEventListener('submit', async function (event) {
			event.preventDefault();

			if (!currentInvoice || !currentProperty) {
				showMessage(paymentMessageBox, "No hay una factura o propiedad seleccionada para pagar.", 'error');
				return;
			}

			const numeroComprobante = currentInvoice.NumeroComprobante;
			const numeroFinca = currentProperty.NumeroFinca;
			// Usamos el valor del input, que ya está cargado con el TotalAPagarFinal.toFixed(2)
			const montoPago = parseFloat(pagoMontoInput.value); 
			const numeroReferencia = document.getElementById('pagoReferencia').value.trim();
			const idTipoMedioPago = document.getElementById('pagoMedio').value;

			if (isNaN(montoPago) || montoPago <= 0) {
				showMessage(paymentMessageBox, "El monto a pagar es inválido.", 'error');
				return;
			}
			if (!idTipoMedioPago) {
				showMessage(paymentMessageBox, "Debe seleccionar un medio de pago.", 'error');
				return;
			}
			
			payButton.disabled = true;
			showMessage(paymentMessageBox, "Procesando pago (esto puede tomar unos segundos)...", 'info');

			try {
				// Llamada al ENDPOINT 4: /api/factura/pay
				const data = await fetchWithRetry('/api/factura/pay', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						numeroComprobante,
						numeroFinca,
						montoPago,
						numeroReferencia,
						idTipoMedioPago: parseInt(idTipoMedioPago)
					})
				});

				if (data.success) {
					showMessage(paymentMessageBox, "¡Pago registrado con éxito!", 'success');
					displayReceipt(data.pago);
					// Ocultar formulario de pago y detalles de factura
					paymentForm.classList.add('hidden');
					invoiceDetails.classList.add('hidden');
                    // Desbloquear campo de búsqueda después del pago
                    document.getElementById('searchTerm').readOnly = false;


				} else {
					showMessage(paymentMessageBox, data.message || 'Fallo al procesar el pago.', 'error');
				}

			} catch (error) {
				showMessage(paymentMessageBox, error.message || 'Error de red o servidor al procesar el pago.', 'error');
				console.error("Payment Error:", error);
			} finally {
				payButton.disabled = false;
			}
		});

		/**
		 * FUNCIÓN AUXILIAR: Muestra el comprobante de pago
		 */
		function displayReceipt(pago) {
			document.getElementById('receiptCodigo').textContent = pago.codigo;
			document.getElementById('receiptMonto').textContent = formatCurrency(pago.monto);
			receiptDetails.classList.remove('hidden');
		}

		// Inicializar la aplicación al cargar la página
		document.addEventListener('DOMContentLoaded', resetApp);

	</script>
</body>
</html>